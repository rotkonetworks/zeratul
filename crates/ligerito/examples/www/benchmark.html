<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ligerito GPU Benchmarks | WebGPU Acceleration</title>
<link rel="stylesheet" href="/style.css">
<style>
.benchmark-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 15px;
  margin: 15px 0;
}

.bench-card {
  background: #1a1a2e;
  border: 1px solid #0ff;
  border-radius: 4px;
  padding: 15px;
}

.bench-title {
  color: #0ff;
  font-weight: bold;
  margin-bottom: 10px;
  font-size: 1.1em;
}

.bench-stat {
  display: flex;
  justify-content: space-between;
  margin: 5px 0;
  font-size: 0.95em;
}

.bench-stat .label {
  color: #888;
}

.bench-stat .value {
  color: #fff;
  font-family: monospace;
}

.progress-bar {
  width: 100%;
  height: 20px;
  background: #0a0a15;
  border: 1px solid #333;
  border-radius: 3px;
  overflow: hidden;
  margin: 10px 0;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #0ff, #00f);
  transition: width 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 0.8em;
}

.speedup-badge {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 3px;
  font-weight: bold;
  font-size: 0.9em;
}

.speedup-good { background: #0f0; color: #000; }
.speedup-medium { background: #ff0; color: #000; }
.speedup-poor { background: #f00; color: #fff; }

.device-info {
  background: #0a0a15;
  padding: 10px;
  border-radius: 4px;
  margin: 10px 0;
  font-size: 0.9em;
}

.mobile-warning {
  background: #ff06;
  border: 1px solid #f00;
  padding: 10px;
  border-radius: 4px;
  margin: 10px 0;
  color: #fcc;
}
</style>
</head>
<body>
<div class="terminal">
<div class="header">ligerito WebGPU Benchmarks | GPU vs CPU Performance</div>
<div class="status" id="status">initializing...</div>

<!-- Device Info -->
<div class="section">
<div class="section-title">â•”â•â•â• device capabilities â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—</div>
<div class="section-content">
  <div class="device-info" id="device-info">detecting...</div>
</div>
<div class="section-footer">â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</div>
</div>

<!-- Benchmark Configuration -->
<div class="section">
<div class="section-title">â•”â•â•â• benchmark configuration â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—</div>
<div class="section-content">
  <label>Test scale:
    <select id="bench-scale">
      <option value="small">Small (n=8, k=4, q=16) - Quick test</option>
      <option value="medium" selected>Medium (n=10, k=6, q=32) - Balanced</option>
      <option value="large">Large (n=12, k=7, q=64) - Heavy</option>
      <option value="xl">XL (n=14, k=7, q=128) - Very Heavy</option>
    </select>
  </label>
  <br><br>
  <label style="display: flex; align-items: center; gap: 10px;">
    <input type="checkbox" id="run-both" checked>
    Run both CPU and GPU (for comparison)
  </label>
  <br>
  <button id="run-bench" class="btn" disabled>Run Benchmark</button>
  <button id="clear-results" class="btn" style="margin-left: 10px;">Clear Results</button>
</div>
<div class="section-footer">â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</div>
</div>

<!-- Results -->
<div class="section">
<div class="section-title">â•”â•â•â• benchmark results â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—</div>
<div class="section-content">
  <div id="bench-results" style="min-height: 100px; color: #888;">
    No results yet. Click "Run Benchmark" to start.
  </div>
</div>
<div class="section-footer">â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</div>
</div>

<!-- Historical Results -->
<div class="section">
<div class="section-title">â•”â•â•â• test history â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—</div>
<div class="section-content">
  <div id="history" style="max-height: 300px; overflow-y: auto; color: #888;">
    No history yet.
  </div>
</div>
<div class="section-footer">â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</div>
</div>

<div class="footer">
  powered by ligerito | WebGPU on <span id="device-name">your device</span> |
  <a href="/">back to main app</a>
</div>
</div>

<script type="module">
// NOTE: This is a UI mockup. Actual WebGPU integration requires:
// 1. Compiling sumcheck GPU code to WASM with wgpu
// 2. Exposing benchmark functions from Rust
// 3. Worker integration for non-blocking execution

let gpuAdapter = null;
let gpuDevice = null;
const history = [];

// Config presets
const CONFIGS = {
  small: { n: 8, k: 4, q: 16 },
  medium: { n: 10, k: 6, q: 32 },
  large: { n: 12, k: 7, q: 64 },
  xl: { n: 14, k: 7, q: 128 }
};

// Initialize WebGPU
async function initGPU() {
  const infoDiv = document.getElementById('device-info');

  if (!navigator.gpu) {
    infoDiv.innerHTML = `
      <div class="mobile-warning">
        âš ï¸ WebGPU not available on this browser.<br>
        Try Chrome 113+ or Edge 113+ on desktop/Android.
      </div>
      <div>Platform: ${navigator.platform}</div>
      <div>User Agent: ${navigator.userAgent}</div>
    `;
    return false;
  }

  try {
    gpuAdapter = await navigator.gpu.requestAdapter({
      powerPreference: 'high-performance'
    });

    if (!gpuAdapter) {
      infoDiv.innerHTML = '<div class="mobile-warning">âŒ No WebGPU adapter available</div>';
      return false;
    }

    gpuDevice = await gpuAdapter.requestDevice();

    const info = await gpuAdapter.requestAdapterInfo?.();
    const limits = gpuAdapter.limits;

    const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
    const deviceType = isMobile ? 'ğŸ“± Mobile' : 'ğŸ–¥ï¸ Desktop';

    document.getElementById('device-name').textContent = info?.vendor || 'Unknown';

    infoDiv.innerHTML = `
      <div style="color: #0f0; font-weight: bold; margin-bottom: 10px;">âœ“ WebGPU Available</div>
      <div><strong>Device:</strong> ${deviceType} - ${info?.vendor || 'Unknown'} ${info?.architecture || ''}</div>
      <div><strong>Backend:</strong> ${info?.device || 'Unknown'}</div>
      <div><strong>Max Buffer:</strong> ${(limits.maxBufferSize / 1024 / 1024).toFixed(0)} MB</div>
      <div><strong>Max Binding:</strong> ${(limits.maxStorageBufferBindingSize / 1024 / 1024).toFixed(0)} MB</div>
      <div><strong>Max Workgroup:</strong> ${limits.maxComputeWorkgroupSizeX}</div>
      ${isMobile ? '<div style="color: #0ff; margin-top: 10px;">ğŸ“± Mobile GPU detected - optimized for battery life</div>' : ''}
    `;

    return true;
  } catch (e) {
    infoDiv.innerHTML = `<div class="mobile-warning">âŒ WebGPU error: ${e.message}</div>`;
    return false;
  }
}

// Simulated benchmark (replace with actual WASM calls)
async function runCPUBenchmark(config) {
  // Simulate CPU time (replace with actual WASM worker call)
  const baseTime = 10 * Math.pow(2, config.n - 8) * (config.q / 16);
  await new Promise(r => setTimeout(r, Math.min(baseTime, 100))); // Cap simulation time
  return baseTime + Math.random() * 5;
}

async function runGPUBenchmark(config) {
  if (!gpuDevice) throw new Error('GPU not initialized');

  // Simulate GPU time (much faster, replace with actual GPU sumcheck)
  const baseTime = 0.5 * Math.pow(1.5, config.n - 8) * (config.q / 32);
  await new Promise(r => setTimeout(r, Math.min(baseTime, 50)));
  return baseTime + Math.random() * 0.2;
}

// Run benchmark
document.getElementById('run-bench').addEventListener('click', async () => {
  const scale = document.getElementById('bench-scale').value;
  const runBoth = document.getElementById('run-both').checked;
  const config = CONFIGS[scale];

  const resultsDiv = document.getElementById('bench-results');
  const runButton = document.getElementById('run-bench');

  runButton.disabled = true;
  resultsDiv.innerHTML = '<div class="progress-bar"><div class="progress-fill" style="width: 10%">Running...</div></div>';

  const results = {
    config: scale,
    ...config,
    timestamp: new Date().toISOString()
  };

  try {
    // CPU Benchmark
    if (runBoth) {
      resultsDiv.innerHTML = '<div class="progress-bar"><div class="progress-fill" style="width: 30%">Running CPU...</div></div>';
      const cpuStart = performance.now();
      await runCPUBenchmark(config);
      results.cpuTime = performance.now() - cpuStart;
    }

    // GPU Benchmark
    resultsDiv.innerHTML = '<div class="progress-bar"><div class="progress-fill" style="width: 70%">Running GPU...</div></div>';
    const gpuStart = performance.now();
    results.gpuTime = await runGPUBenchmark(config);

    // Display results
    displayResults(results);

    // Add to history
    history.unshift(results);
    if (history.length > 10) history.pop();
    updateHistory();

  } catch (e) {
    resultsDiv.innerHTML = `<div style="color: #f00;">âŒ Benchmark failed: ${e.message}</div>`;
  } finally {
    runButton.disabled = false;
  }
});

function displayResults(results) {
  const speedup = results.cpuTime / results.gpuTime;
  const speedupClass = speedup > 20 ? 'speedup-good' : speedup > 5 ? 'speedup-medium' : 'speedup-poor';

  let html = '<div class="benchmark-grid">';

  if (results.cpuTime) {
    html += `
      <div class="bench-card">
        <div class="bench-title">CPU Performance</div>
        <div class="bench-stat">
          <span class="label">Time:</span>
          <span class="value">${results.cpuTime.toFixed(2)} ms</span>
        </div>
        <div class="bench-stat">
          <span class="label">Mode:</span>
          <span class="value">WASM Single-thread</span>
        </div>
      </div>
    `;
  }

  html += `
    <div class="bench-card">
      <div class="bench-title">GPU Performance</div>
      <div class="bench-stat">
        <span class="label">Time:</span>
        <span class="value" style="color: #0f0;">${results.gpuTime.toFixed(2)} ms</span>
      </div>
      <div class="bench-stat">
        <span class="label">Mode:</span>
        <span class="value">WebGPU Compute</span>
      </div>
    </div>
  `;

  if (results.cpuTime) {
    html += `
      <div class="bench-card">
        <div class="bench-title">Speedup</div>
        <div class="bench-stat">
          <span class="label">GPU vs CPU:</span>
          <span class="value"><span class="speedup-badge ${speedupClass}">${speedup.toFixed(1)}x faster</span></span>
        </div>
        <div class="bench-stat">
          <span class="label">Config:</span>
          <span class="value">n=${results.n}, k=${results.k}, q=${results.q}</span>
        </div>
      </div>
    `;
  }

  html += '</div>';

  html += `
    <div style="margin-top: 15px; padding: 10px; background: #0a0a15; border-radius: 4px; font-size: 0.9em;">
      <div style="color: #888;">Test Parameters:</div>
      <div>â€¢ Basis size: 2^${results.n} = ${Math.pow(2, results.n).toLocaleString()} elements</div>
      <div>â€¢ Row size: 2^${results.k} = ${Math.pow(2, results.k)} elements</div>
      <div>â€¢ Queries: ${results.q}</div>
      <div>â€¢ Total operations: ~${(Math.pow(2, results.n) * results.q).toLocaleString()}</div>
    </div>
  `;

  document.getElementById('bench-results').innerHTML = html;
}

function updateHistory() {
  const historyDiv = document.getElementById('history');

  if (history.length === 0) {
    historyDiv.innerHTML = '<div style="color: #888;">No history yet.</div>';
    return;
  }

  let html = '<table style="width: 100%; font-size: 0.9em;">';
  html += '<tr style="color: #0ff; border-bottom: 1px solid #333;"><th>Time</th><th>Config</th><th>CPU</th><th>GPU</th><th>Speedup</th></tr>';

  history.forEach(r => {
    const speedup = r.cpuTime ? (r.cpuTime / r.gpuTime).toFixed(1) + 'x' : '-';
    html += `
      <tr style="border-bottom: 1px solid #222;">
        <td style="padding: 5px;">${new Date(r.timestamp).toLocaleTimeString()}</td>
        <td>${r.config}</td>
        <td>${r.cpuTime ? r.cpuTime.toFixed(1) + 'ms' : '-'}</td>
        <td style="color: #0f0;">${r.gpuTime.toFixed(1)}ms</td>
        <td style="color: #0ff;">${speedup}</td>
      </tr>
    `;
  });

  html += '</table>';
  historyDiv.innerHTML = html;
}

document.getElementById('clear-results').addEventListener('click', () => {
  document.getElementById('bench-results').innerHTML = '<div style="color: #888;">No results yet. Click "Run Benchmark" to start.</div>';
});

// Initialize
(async () => {
  const hasGPU = await initGPU();

  if (hasGPU) {
    document.getElementById('status').innerHTML = '<span class="ok">âœ“ Ready - WebGPU Enabled</span>';
    document.getElementById('run-bench').disabled = false;
  } else {
    document.getElementById('status').innerHTML = '<span class="err">âœ— WebGPU not available - CPU only</span>';
    // Still allow CPU-only benchmarking
    document.getElementById('run-bench').disabled = false;
    document.getElementById('run-both').checked = false;
    document.getElementById('run-both').disabled = true;
  }
})();
</script>
</body>
</html>
