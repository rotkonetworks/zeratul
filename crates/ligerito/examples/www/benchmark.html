<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ligerito benchmarks | CPU vs WebGPU</title>
<link rel="stylesheet" href="/style.css">
<style>
.bench-result { margin: 10px 0; padding: 10px; background: #1a1a2e; border-radius: 4px; }
.bench-row { display: flex; justify-content: space-between; margin: 5px 0; }
.bench-label { color: #888; }
.bench-value { color: #0f0; font-family: monospace; }
.speedup { color: #0ff; font-weight: bold; }
.section-sub { margin: 15px 0; padding: 10px; border: 1px dashed #333; }
</style>
</head>
<body>
<div class="terminal">
<div class="header">ligerito benchmarks | CPU vs WebGPU</div>
<div class="status" id="status">initializing...</div>

<div class="section">
<div class="section-title">╔═══ sumcheck benchmark ═══════════════════════════════════════════════════════════════╗</div>
<div class="section-content">
  <label>preset:
    <select id="preset">
      <option value="20" selected>2^20 (n=10, k=10, q=148)</option>
      <option value="24">2^24 (n=18, k=6, q=148)</option>
    </select>
  </label>
  <span style="margin-left: 15px; color: #888; font-size: 0.9em;">
    custom: n=<input type="number" id="n" value="10" min="4" max="20" style="width:50px">
    k=<input type="number" id="k" value="10" min="2" max="12" style="width:50px">
    q=<input type="number" id="q" value="148" min="1" max="256" style="width:50px">
  </span>
  <br><br>
  <label><input type="checkbox" id="run-cpu" checked> CPU</label>
  <label style="margin-left: 15px;"><input type="checkbox" id="run-gpu" checked> WebGPU</label>
  <button id="run-sumcheck-btn" class="btn" style="margin-left: 15px;" disabled>run sumcheck</button>
  <div id="sumcheck-output" class="output" style="margin-top: 10px;"></div>
</div>
<div class="section-footer">╚═════════════════════════════════════════════════════════════════════════════════════╝</div>
</div>

<div class="section">
<div class="section-title">╔═══ prove/verify benchmark ═══════════════════════════════════════════════════════════╗</div>
<div class="section-content">
  <label>polynomial size:
    <select id="poly-size">
      <option value="12">2^12 (4K elements)</option>
      <option value="20" selected>2^20 (1M elements)</option>
      <option value="24">2^24 (16M elements)</option>
    </select>
  </label>
  <br><br>
  <label><input type="checkbox" id="pv-cpu" checked> CPU</label>
  <label style="margin-left: 15px;"><input type="checkbox" id="pv-gpu" checked> WebGPU</label>
  <button id="run-pv-btn" class="btn" style="margin-left: 15px;" disabled>run prove+verify</button>
  <div id="pv-output" class="output" style="margin-top: 10px;"></div>
</div>
<div class="section-footer">╚═════════════════════════════════════════════════════════════════════════════════════╝</div>
</div>

<div class="section">
<div class="section-title">╔═══ history ══════════════════════════════════════════════════════════════════════════╗</div>
<div class="section-content">
  <div id="history" style="max-height: 300px; overflow-y: auto; color: #888;">no results yet</div>
</div>
<div class="section-footer">╚═════════════════════════════════════════════════════════════════════════════════════╝</div>
</div>

<div class="footer">
  <a href="/">← back to main</a>
</div>
</div>

<script type="module">
import initGpu, { 
  BenchConfig, bench_cpu_sumcheck, bench_gpu_sumcheck,
  prove as proveGpu, verify as verifyGpu, get_polynomial_size as getSizeGpu
} from './webgpu/ligerito.js';

import initCpu, { 
  prove as proveCpu, verify as verifyCpu, get_polynomial_size as getSizeCpu 
} from './ligerito.js';

let gpuAvailable = false;
const history = [];

const PRESETS = {
  '20': { n: 10, k: 10, q: 148 },
  '24': { n: 18, k: 6, q: 148 }
};

document.getElementById('preset').addEventListener('change', (e) => {
  const p = PRESETS[e.target.value];
  document.getElementById('n').value = p.n;
  document.getElementById('k').value = p.k;
  document.getElementById('q').value = p.q;
});

// js-side webgpu check (rust one is buggy)
async function checkGPU() {
  if (!navigator.gpu) return false;
  try {
    const adapter = await navigator.gpu.requestAdapter();
    return !!adapter;
  } catch { return false; }
}

try {
  await Promise.all([initGpu(), initCpu()]);
  gpuAvailable = await checkGPU();
  
  const gpuStatus = gpuAvailable 
    ? '<span style="color:#0f0">WebGPU ✓</span>' 
    : '<span style="color:#ff0">WebGPU ✗</span>';
  
  document.getElementById('status').innerHTML = `<span class="ok">✓ ready</span> | ${gpuStatus}`;
  document.getElementById('run-sumcheck-btn').disabled = false;
  document.getElementById('run-pv-btn').disabled = false;
  
  if (!gpuAvailable) {
    document.getElementById('run-gpu').disabled = true;
    document.getElementById('run-gpu').checked = false;
    document.getElementById('pv-gpu').disabled = true;
    document.getElementById('pv-gpu').checked = false;
  }
} catch (e) {
  document.getElementById('status').innerHTML = `<span class="err">✗ ${e}</span>`;
}

// sumcheck benchmark
document.getElementById('run-sumcheck-btn').addEventListener('click', async () => {
  const n = parseInt(document.getElementById('n').value);
  const k = parseInt(document.getElementById('k').value);
  const q = parseInt(document.getElementById('q').value);
  const runCPU = document.getElementById('run-cpu').checked;
  const runGPU = document.getElementById('run-gpu').checked && gpuAvailable;
  const output = document.getElementById('sumcheck-output');
  const btn = document.getElementById('run-sumcheck-btn');

  if (!runCPU && !runGPU) {
    output.innerHTML = '<span class="err">select at least one backend</span>';
    return;
  }

  btn.disabled = true;
  const result = { type: 'sumcheck', n, k, q, timestamp: new Date() };

  try {
    if (runCPU) {
      output.innerHTML = '<span class="warn">CPU sumcheck...</span>';
      const config = new BenchConfig(n, k, q);
      const r = await bench_cpu_sumcheck(config);
      result.cpuTime = r.time_ms;
      result.cpuSuccess = r.success;
    }

    if (runGPU) {
      output.innerHTML = '<span class="warn">GPU sumcheck...</span>';
      const config = new BenchConfig(n, k, q);
      const r = await bench_gpu_sumcheck(config);
      result.gpuTime = r.time_ms;
      result.gpuSuccess = r.success;
    }

    history.unshift(result);
    displaySumcheckResult(result, output);
    updateHistory();
  } catch (e) {
    output.innerHTML = `<span class="err">✗ ${e}</span>`;
  }

  btn.disabled = false;
});

// prove/verify benchmark
document.getElementById('run-pv-btn').addEventListener('click', async () => {
  const configSize = parseInt(document.getElementById('poly-size').value);
  const runCPU = document.getElementById('pv-cpu').checked;
  const runGPU = document.getElementById('pv-gpu').checked && gpuAvailable;
  const output = document.getElementById('pv-output');
  const btn = document.getElementById('run-pv-btn');

  if (!runCPU && !runGPU) {
    output.innerHTML = '<span class="err">select at least one backend</span>';
    return;
  }

  btn.disabled = true;

  try {
    // generate polynomial
    output.innerHTML = '<span class="warn">generating polynomial...</span>';
    const size = getSizeCpu(configSize);
    const polynomial = new Uint32Array(size);
    for (let i = 0; i < size; i++) {
      polynomial[i] = Math.floor(Math.random() * 0xFFFFFFFF);
    }

    const result = { type: 'prove/verify', configSize, size, timestamp: new Date() };

    if (runCPU) {
      output.innerHTML = '<span class="warn">CPU proving...</span>';
      const cpuProveStart = performance.now();
      const cpuProof = proveCpu(polynomial, configSize);
      result.cpuProveTime = performance.now() - cpuProveStart;
      result.proofSize = cpuProof.length;

      output.innerHTML = '<span class="warn">CPU verifying...</span>';
      const cpuVerifyStart = performance.now();
      result.cpuValid = verifyCpu(cpuProof, configSize);
      result.cpuVerifyTime = performance.now() - cpuVerifyStart;
    }

    if (runGPU) {
      output.innerHTML = '<span class="warn">GPU proving...</span>';
      const gpuProveStart = performance.now();
      const gpuProof = proveGpu(polynomial, configSize);
      result.gpuProveTime = performance.now() - gpuProveStart;
      if (!result.proofSize) result.proofSize = gpuProof.length;

      output.innerHTML = '<span class="warn">GPU verifying...</span>';
      const gpuVerifyStart = performance.now();
      result.gpuValid = verifyGpu(gpuProof, configSize);
      result.gpuVerifyTime = performance.now() - gpuVerifyStart;
    }

    history.unshift(result);
    displayPVResult(result, output);
    updateHistory();
  } catch (e) {
    output.innerHTML = `<span class="err">✗ ${e}</span>`;
  }

  btn.disabled = false;
});

function displaySumcheckResult(r, el) {
  let html = `<div class="bench-result">
    <div class="bench-row"><span class="bench-label">config:</span><span class="bench-value">n=${r.n}, k=${r.k}, q=${r.q}</span></div>`;

  if (r.cpuTime !== undefined) {
    html += `<div class="bench-row"><span class="bench-label">CPU:</span><span class="bench-value">${r.cpuTime.toFixed(2)} ms ${r.cpuSuccess ? '✓' : '✗'}</span></div>`;
  }
  if (r.gpuTime !== undefined) {
    html += `<div class="bench-row"><span class="bench-label">GPU:</span><span class="bench-value">${r.gpuTime.toFixed(2)} ms ${r.gpuSuccess ? '✓' : '✗'}</span></div>`;
  }
  if (r.cpuTime && r.gpuTime && r.gpuTime > 0) {
    html += `<div class="bench-row"><span class="bench-label">speedup:</span><span class="speedup">${(r.cpuTime / r.gpuTime).toFixed(2)}x</span></div>`;
  }

  html += '</div>';
  el.innerHTML = html;
}

function displayPVResult(r, el) {
  const polyKB = (r.size * 4 / 1024).toFixed(1);
  const proofKB = (r.proofSize / 1024).toFixed(1);

  let html = `<div class="bench-result">
    <div class="bench-row"><span class="bench-label">polynomial:</span><span class="bench-value">2^${r.configSize} (${r.size.toLocaleString()} elements, ${polyKB} KB)</span></div>
    <div class="bench-row"><span class="bench-label">proof:</span><span class="bench-value">${proofKB} KB (${(r.size * 4 / r.proofSize).toFixed(1)}x compression)</span></div>`;

  if (r.cpuProveTime !== undefined) {
    html += `<div class="bench-row"><span class="bench-label">CPU prove:</span><span class="bench-value">${r.cpuProveTime.toFixed(0)} ms</span></div>`;
    html += `<div class="bench-row"><span class="bench-label">CPU verify:</span><span class="bench-value">${r.cpuVerifyTime.toFixed(0)} ms ${r.cpuValid ? '✓' : '✗'}</span></div>`;
  }
  if (r.gpuProveTime !== undefined) {
    html += `<div class="bench-row"><span class="bench-label">GPU prove:</span><span class="bench-value">${r.gpuProveTime.toFixed(0)} ms</span></div>`;
    html += `<div class="bench-row"><span class="bench-label">GPU verify:</span><span class="bench-value">${r.gpuVerifyTime.toFixed(0)} ms ${r.gpuValid ? '✓' : '✗'}</span></div>`;
  }
  if (r.cpuProveTime && r.gpuProveTime && r.gpuProveTime > 0) {
    html += `<div class="bench-row"><span class="bench-label">prove speedup:</span><span class="speedup">${(r.cpuProveTime / r.gpuProveTime).toFixed(2)}x</span></div>`;
  }

  html += '</div>';
  el.innerHTML = html;
}

function updateHistory() {
  const el = document.getElementById('history');
  if (!history.length) { el.innerHTML = 'no results yet'; return; }

  el.innerHTML = history.map(r => {
    let txt = '';
    if (r.type === 'sumcheck') {
      txt = `[sumcheck] n=${r.n} k=${r.k}: `;
      if (r.cpuTime) txt += `CPU ${r.cpuTime.toFixed(1)}ms `;
      if (r.gpuTime) txt += `GPU ${r.gpuTime.toFixed(1)}ms `;
      if (r.cpuTime && r.gpuTime) txt += `(${(r.cpuTime/r.gpuTime).toFixed(1)}x)`;
    } else {
      txt = `[prove] 2^${r.configSize}: `;
      if (r.cpuProveTime) txt += `CPU ${r.cpuProveTime.toFixed(0)}ms `;
      if (r.gpuProveTime) txt += `GPU ${r.gpuProveTime.toFixed(0)}ms `;
      if (r.cpuProveTime && r.gpuProveTime) txt += `(${(r.cpuProveTime/r.gpuProveTime).toFixed(1)}x)`;
    }
    return `<div style="border-bottom: 1px solid #333; padding: 5px 0; font-size: 0.9em;">
      ${txt} <span style="color: #666;">(${r.timestamp.toLocaleTimeString()})</span>
    </div>`;
  }).join('');
}
</script>
</body>
</html>
