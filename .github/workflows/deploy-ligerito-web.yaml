name: Deploy Ligerito Web Demo

on:
  push:
    branches: [master]
    paths:
      - 'crates/ligerito/**'
      - 'crates/binary-fields/**'
      - 'crates/reed-solomon/**'
      - 'crates/merkle-tree/**'
      - '.github/workflows/deploy-ligerito-web.yaml'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: nightly
          components: rust-src
          target: wasm32-unknown-unknown

      - name: Install wasm-bindgen-cli
        run: cargo install wasm-bindgen-cli --vers 0.2.105

      - name: Build WASM with SIMD
        working-directory: crates/ligerito/scripts
        run: |
          chmod +x build-wasm-parallel.sh
          ./build-wasm-parallel.sh

      - name: Create deployment package
        working-directory: crates/ligerito/scripts
        run: |
          chmod +x deploy.sh
          ./deploy.sh

      - name: Upload to ligerito.rotko.net
        run: |
          echo "${{ secrets.DEPLOY_KEY }}" > ssh_key
          chmod 600 ssh_key

          PORT="${{ secrets.DEPLOY_HOST_PORT }}"
          PORT="${PORT:-22}"

          # Upload to deploy directory
          scp -i ssh_key -o StrictHostKeyChecking=no \
            -P "$PORT" \
            -r crates/ligerito/scripts/deploy/* \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:~/ligerito-web/

          # Rebuild and restart docker container
          ssh -i ssh_key -o StrictHostKeyChecking=no \
            -p "$PORT" \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "cd ~/ligerito-web && docker build -t ligeritorotkonet_ligerito:latest . && docker stop ligerito-wasm && docker rm ligerito-wasm && docker run -d --name ligerito-wasm --restart unless-stopped -p 127.0.0.1:8090:8080 ligeritorotkonet_ligerito:latest"

          rm ssh_key

      - name: Deployment Summary
        run: |
          echo "### Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://ligerito.rotko.net" >> $GITHUB_STEP_SUMMARY
          echo "- **WASM Size**: $(du -h crates/ligerito/scripts/deploy/ligerito_bg.wasm | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Features**: WASM SIMD128, Multi-threading, WebGPU detection" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
